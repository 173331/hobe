-- ====================== FEDLY AUTO WALK SYSTEM (NO KEY) ======================
-- ‚úì Auto Walk Recorder (with animations)
-- ‚úì Auto Walk Playback
-- ‚úì Loop feature
-- ‚úì Height adjustment
-- ‚úì Save/Load recordings
-- =====================================================================================

local Player = game.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- ================= KONFIGURASI =================
local DISCORD_LINK = "https://discord.gg/7NJcmnKrEm"
local RECORDINGS_FILE = "saved_recordings.txt"

-- ================= VARIABEL =================
-- Detect screen size
local screenSize = workspace.CurrentCamera.ViewportSize
local isMobile = screenSize.X < 1000
print("DEBUG: screenSize.X = " .. screenSize.X .. ", isMobile = " .. tostring(isMobile))

-- ================= VARIABEL RECORDER =================
local loopEnabled = false
local recordedFrames = nil

-- ================= AUTO WALK STORAGE =================
local function serializeCFrame(cf)
	local p = cf.Position
	local rx, ry, rz = cf:ToOrientation()
	return string.format("%.2f,%.2f,%.2f,%.4f,%.4f,%.4f", p.X, p.Y, p.Z, rx, ry, rz)
end

local function parseCFrame(str)
	local parts = string.split(str, ",")
	local pos = Vector3.new(tonumber(parts[1]), tonumber(parts[2]), tonumber(parts[3]))
	return CFrame.new(pos) * CFrame.fromOrientation(tonumber(parts[4]), tonumber(parts[5]), tonumber(parts[6]))
end

local function serialize(name, frames, hipHeight, animationIds)
	local parts = {name, tostring(hipHeight or 0)}
	
	-- Add animation IDs (comma separated)
	if animationIds and #animationIds > 0 then
		table.insert(parts, table.concat(animationIds, ","))
	else
		table.insert(parts, "")
	end
	
	for _, frame in ipairs(frames) do
		table.insert(parts, serializeCFrame(frame.cframe) .. ";" .. tostring(frame.timestamp))
	end
	return table.concat(parts, "|")
end

local function deserialize(data)
	local parts = string.split(data, "|")
	local hipHeight = tonumber(parts[2]) or 0
	
	-- Parse animation IDs
	local animationIds = {}
	if parts[3] and #parts[3] > 0 then
		for _, id in ipairs(string.split(parts[3], ",")) do
			local numId = tonumber(id)
			if numId then
				table.insert(animationIds, numId)
			end
		end
	end
	
	local frames = {}
	for i = 4, #parts do
		pcall(function()
			local frameData = string.split(parts[i], ";")
			local timestamp = tonumber(frameData[2]) or ((i - 4) * 0.1)
			table.insert(frames, {
				cframe = parseCFrame(frameData[1]),
				timestamp = timestamp
			})
		end)
	end
	return {name = parts[1], frames = frames, frameCount = #frames, hipHeight = hipHeight, animationIds = animationIds}
end

-- ================= RECORDER =================
local Recorder = {}
Recorder.__index = Recorder

function Recorder.new(char)
	local hrp = char:FindFirstChild("HumanoidRootPart")
	local humanoid = char:FindFirstChild("Humanoid")
	
	return setmetatable({
		char = char,
		root = hrp,
		humanoid = humanoid,
		hipHeight = humanoid and humanoid.HipHeight or 0,
		active = false,
		frames = {},
		start_time = 0,
		conn = nil
	}, Recorder)
end

function Recorder:start()
	self.active = true
	self.frames = {}
	self.animationIds = {} -- Store animation IDs
	self.start_time = tick()
	self.last_record = 0
	
	-- Capture current animations
	if self.humanoid then
		local animator = self.humanoid:FindFirstChildOfClass("Animator")
		if animator then
			for _, track in ipairs(animator:GetPlayingAnimationTracks()) do
				local animId = track.Animation.AnimationId
				-- Extract numeric ID from rbxassetid://
				local numId = animId:match("%d+")
				if numId then
					table.insert(self.animationIds, tonumber(numId))
					print("üìπ Recording with animation: " .. numId)
				end
			end
		end
	end
	
	local SAMPLE_INTERVAL = 0.1
	
	self.conn = RunService.Heartbeat:Connect(function()
		if self.root then
			local now = tick()
			local elapsed = now - self.start_time
			
			if elapsed - self.last_record >= SAMPLE_INTERVAL then
				table.insert(self.frames, {
					cframe = self.root.CFrame,
					timestamp = elapsed
				})
				self.last_record = elapsed
			end
		end
	end)
end

function Recorder:stop()
	self.active = false
	if self.conn then self.conn:Disconnect() end
	local f = self.frames
	local h = self.hipHeight
	local anims = self.animationIds
	self.frames = {}
	self.animationIds = {}
	return f, h, anims
end

-- ================= PLAYBACK =================
local Playback = {}
Playback.__index = Playback

function Playback.new(char, recording)
	local hrp = char:FindFirstChild("HumanoidRootPart")
	local humanoid = char:FindFirstChild("Humanoid")
	
	return setmetatable({
		char = char,
		root = hrp,
		humanoid = humanoid,
		recording = recording,
		recordedHipHeight = recording.hipHeight or 0,
		currentHipHeight = humanoid and humanoid.HipHeight or 0,
		heightOffset = 0,
		active = false,
		index = 1,
		start_time = 0,
		conn = nil
	}, Playback)
end

function Playback:start()
	print("========================================")
	print("üé¨ Playback:start() called")
	print("========================================")
	
	if not self.root then
		warn("‚ùå CRITICAL ERROR: self.root is nil!")
		warn("‚ùå Cannot start playback without HumanoidRootPart")
		return
	end
	print("‚úÖ Root exists: " .. tostring(self.root))
	
	if not self.recording then
		warn("‚ùå CRITICAL ERROR: self.recording is nil!")
		return
	end
	print("‚úÖ Recording exists")
	
	if not self.recording.frames then
		warn("‚ùå CRITICAL ERROR: self.recording.frames is nil!")
		return
	end
	print("‚úÖ Recording frames exist: " .. #self.recording.frames)
	
	if #self.recording.frames == 0 then
		warn("‚ùå ERROR: Recording has 0 frames!")
		return
	end
	
	self.active = true
	self.index = 1
	self.start_time = tick()
	
	self.heightOffset = self.currentHipHeight - self.recordedHipHeight
	
	print("üé¨ Playback started, frames: " .. #self.recording.frames)
	print("üé≠ Animation: " .. selectedAnimPackage)
	print("üìè Height offset: " .. self.heightOffset)
	print("‚è±Ô∏è Start time: " .. self.start_time)
	
	local humanoid = self.char:FindFirstChild("Humanoid")
	
	self.originalWalkSpeed = humanoid and humanoid.WalkSpeed or 16
	self.originalJumpPower = humanoid and humanoid.JumpPower or 50
	
	if self.runAnim then 
		pcall(function() self.runAnim:Stop() end)
		pcall(function() self.runAnim:Destroy() end)
	end
	if self.jumpAnim then 
		pcall(function() self.jumpAnim:Stop() end)
		pcall(function() self.jumpAnim:Destroy() end)
	end
	if self.fallAnim then 
		pcall(function() self.fallAnim:Stop() end)
		pcall(function() self.fallAnim:Destroy() end)
	end
	if self.idleAnim then 
		pcall(function() self.idleAnim:Stop() end)
		pcall(function() self.idleAnim:Destroy() end)
	end
	
	self.runAnim = nil
	self.jumpAnim = nil
	self.fallAnim = nil
	self.idleAnim = nil
	
	-- Load animations from recording (if available)
	if humanoid and recording.animationIds and #recording.animationIds >= 4 then
		pcall(function()
			local runAnimObj = Instance.new("Animation")
			runAnimObj.AnimationId = "rbxassetid://" .. tostring(recording.animationIds[1])
			
			local jumpAnimObj = Instance.new("Animation")
			jumpAnimObj.AnimationId = "rbxassetid://" .. tostring(recording.animationIds[2] or recording.animationIds[1])
			
			local fallAnimObj = Instance.new("Animation")
			fallAnimObj.AnimationId = "rbxassetid://" .. tostring(recording.animationIds[3] or recording.animationIds[1])
			
			local idleAnimObj = Instance.new("Animation")
			idleAnimObj.AnimationId = "rbxassetid://" .. tostring(recording.animationIds[4] or recording.animationIds[1])
			
			self.runAnim = humanoid:LoadAnimation(runAnimObj)
			self.jumpAnim = humanoid:LoadAnimation(jumpAnimObj)
			self.fallAnim = humanoid:LoadAnimation(fallAnimObj)
			self.idleAnim = humanoid:LoadAnimation(idleAnimObj)
			
			print("‚úÖ Loaded recorded animations")
		end)
	end
	
	if humanoid then
		humanoid.WalkSpeed = 0
		humanoid.AutoRotate = false
		humanoid.PlatformStand = false
	end
	
	if self.root then
		self.root.Anchored = false
		self.root.CanCollide = true
	end
	
	local currentAnim = nil
	local lastY = self.root.Position.Y
	local heartbeatCount = 0
	
	print("üîÑ Setting up Heartbeat connection...")
	
	self.conn = RunService.Heartbeat:Connect(function(dt)
		heartbeatCount = heartbeatCount + 1
		
		-- Debug every 30 frames (about 0.5 seconds)
		if heartbeatCount % 30 == 1 then
			print("üíì Heartbeat #" .. heartbeatCount .. " - Index: " .. self.index .. "/" .. #self.recording.frames)
		end
		
		if not self.active then 
			print("‚èπÔ∏è Playback not active, stopping heartbeat")
			return 
		end
		
		if not self.root or not self.root.Parent then
			warn("‚ùå Root lost, stopping playback")
			self:stop()
			return
		end
		
		local elapsed = tick() - self.start_time
		local frames = self.recording.frames
		
		if self.index > #frames then
			self:stop()
			return
		end
		
		if self.index < #frames then
			local nextFrame = frames[self.index + 1]
			if nextFrame and elapsed >= nextFrame.timestamp then
				self.index = self.index + 1
			end
		end
		
		if self.index >= #frames then
			self.root.CFrame = frames[#frames].cframe
			if loopEnabled then
				self:restart()
				return
			else
				self:stop()
				return
			end
		end
		
		local curr = frames[self.index]
		local next = frames[self.index + 1]
		
		if not curr or not next then
			self:stop()
			return
		end
		
		local duration = next.timestamp - curr.timestamp
		
		if duration > 0 then
			local progress = elapsed - curr.timestamp
			local alpha = math.clamp(progress / duration, 0, 1)
			
			local targetCFrame = curr.cframe:Lerp(next.cframe, alpha)
			local adjustedCFrame = targetCFrame + Vector3.new(0, self.heightOffset, 0)
			
			-- Smooth teleport with velocity reset
			self.root.CFrame = adjustedCFrame
			self.root.AssemblyLinearVelocity = Vector3.zero
			self.root.AssemblyAngularVelocity = Vector3.zero
			
			local deltaPos = next.cframe.Position - curr.cframe.Position
			local horizontalDelta = Vector3.new(deltaPos.X, 0, deltaPos.Z)
			local horizontalSpeed = horizontalDelta.Magnitude / duration
			local verticalSpeed = deltaPos.Y / duration
			
			local currentY = adjustedCFrame.Position.Y
			local deltaY = currentY - lastY
			
			if self.runAnim and self.jumpAnim and self.fallAnim then
				if verticalSpeed > 2 or deltaY > 0.5 then
					if currentAnim ~= "jump" then
						if self.runAnim then self.runAnim:Stop() end
						if self.fallAnim then self.fallAnim:Stop() end
						if self.idleAnim then self.idleAnim:Stop() end
						self.jumpAnim:Play()
						currentAnim = "jump"
					end
				elseif verticalSpeed < -2 or deltaY < -0.5 then
					if currentAnim ~= "fall" then
						if self.runAnim then self.runAnim:Stop() end
						if self.jumpAnim then self.jumpAnim:Stop() end
						if self.idleAnim then self.idleAnim:Stop() end
						self.fallAnim:Play()
						currentAnim = "fall"
					end
				elseif horizontalSpeed > 0.5 then
					if currentAnim ~= "run" then
						if self.jumpAnim then self.jumpAnim:Stop() end
						if self.fallAnim then self.fallAnim:Stop() end
						if self.idleAnim then self.idleAnim:Stop() end
						self.runAnim:Play()
						currentAnim = "run"
					end
				else
					if currentAnim ~= "idle" then
						if self.runAnim then self.runAnim:Stop() end
						if self.jumpAnim then self.jumpAnim:Stop() end
						if self.fallAnim then self.fallAnim:Stop() end
						if self.idleAnim then 
							self.idleAnim:Play()
						end
						currentAnim = "idle"
					end
				end
			end
			
			lastY = currentY
		else
			self.root.CFrame = curr.cframe
		end
	end)
	
	print("‚úÖ Heartbeat connection established!")
	print("‚úÖ Playback:start() completed successfully")
	print("========================================")
end

function Playback:stop()
	self.active = false
	
	if self.conn then 
		self.conn:Disconnect()
		self.conn = nil
	end
	
	if self.runAnim then 
		pcall(function() self.runAnim:Stop() end)
		pcall(function() self.runAnim:Destroy() end)
		self.runAnim = nil
	end
	if self.jumpAnim then 
		pcall(function() self.jumpAnim:Stop() end)
		pcall(function() self.jumpAnim:Destroy() end)
		self.jumpAnim = nil
	end
	if self.fallAnim then 
		pcall(function() self.fallAnim:Stop() end)
		pcall(function() self.fallAnim:Destroy() end)
		self.fallAnim = nil
	end
	if self.idleAnim then 
		pcall(function() self.idleAnim:Stop() end)
		pcall(function() self.idleAnim:Destroy() end)
		self.idleAnim = nil
	end
	
	if self.char and self.char:FindFirstChild("Humanoid") then
		local humanoid = self.char.Humanoid
		humanoid.WalkSpeed = self.originalWalkSpeed or 16
		humanoid.JumpPower = self.originalJumpPower or 50
		humanoid.AutoRotate = true
		humanoid.PlatformStand = false
	end
	
	if self.root then
		self.root.Anchored = false
		self.root.AssemblyLinearVelocity = Vector3.zero
		self.root.AssemblyAngularVelocity = Vector3.zero
	end
	
	print("‚èπÔ∏è Playback stopped")
end

function Playback:restart()
	self.index = 1
	self.start_time = tick()
	print("üîÑ Playback restarted")
end

-- ================= SYSTEM =================
local System = {}
System.__index = System

function System.new()
	return setmetatable({
		state = "idle",
		recorder = nil,
		playback = nil
	}, System)
end

function System:startRecording(char)
	self:forceStop()
	self.recorder = Recorder.new(char)
	self.recorder:start()
	self.state = "recording"
end

function System:stopRecording()
	if not self.recorder then return nil, nil, nil end
	local frames, hipHeight, animationIds = self.recorder:stop()
	self.recorder = nil
	self.state = "idle"
	return frames, hipHeight, animationIds
end

function System:startPlayback(char, recording)
	print("üéÆ System:startPlayback called")
	print("   - Character: " .. tostring(char))
	print("   - Recording frames: " .. (recording and #recording.frames or "nil"))
	
	self:forceStop()
	print("‚úÖ Force stopped previous playback/recording")
	
	self.playback = Playback.new(char, recording)
	print("‚úÖ Playback object created")
	
	if not self.playback then
		warn("‚ùå ERROR: Failed to create playback object!")
		return
	end
	
	if not self.playback.root then
		warn("‚ùå ERROR: Playback root (HumanoidRootPart) is nil!")
		return
	end
	
	print("üé¨ Calling playback:start()...")
	self.playback:start()
	self.state = "playing"
	print("‚úÖ System state changed to: playing")
end

function System:forceStop()
	if self.recorder then
		self.recorder:stop()
		self.recorder = nil
	end
	if self.playback then
		self.playback:stop()
		self.playback = nil
	end
	self.state = "idle"
end

-- ================= INITIALIZE SYSTEM EARLY =================
local system = System.new()
local recordedFrames = nil
print("‚úÖ System initialized early")

-- ================= AUTO WALK RECORDING MANAGER =================
local recordings = {}
local STORAGE_FILE = "autowalk_recordings.txt"

local function saveAllRecordingsToFile()
	local lines = {}
	for name, data in pairs(recordings) do
		table.insert(lines, name .. "##" .. data)
	end
	
	local success = pcall(function()
		writefile(STORAGE_FILE, table.concat(lines, "\n"))
	end)
	
	if success then
		print("‚úÖ Saved " .. #lines .. " recording(s)")
	else
		warn("‚ùå Failed to save recordings")
	end
	
	return success
end

local function loadAllRecordingsFromFile()
	local loaded = 0
	
	if not readfile or not isfile then
		warn("‚ö†Ô∏è File functions not available")
		return 0
	end
	
	if not isfile(STORAGE_FILE) then
		print("üì≠ No saved recordings")
		return 0
	end
	
	print("üîç Loading from: " .. STORAGE_FILE)
	
	local success, fileData = pcall(function()
		return readfile(STORAGE_FILE)
	end)
	
	if not success or not fileData or #fileData == 0 then
		warn("‚ùå Failed to read file")
		return 0
	end
	
	local lines = string.split(fileData, "\n")
	
	for _, line in ipairs(lines) do
		if line and #line > 0 then
			local sepPos = line:find("##")
			if sepPos then
				local name = line:sub(1, sepPos - 1)
				local data = line:sub(sepPos + 2)
				
				if name and data and #name > 0 and #data > 0 then
					recordings[name] = data
					loaded = loaded + 1
					print("‚úÖ Loaded: " .. name)
				end
			end
		end
	end
	
	print("‚úÖ Total loaded: " .. loaded)
	return loaded
end

local function saveRecording(name, data)
	recordings[name] = data
	saveAllRecordingsToFile()
	return true
end

local function loadRecording(name)
	return recordings[name]
end

local function listRecordings()
	local list = {}
	for name in pairs(recordings) do
		table.insert(list, name)
	end
	table.sort(list)
	return list
end

local function deleteRecording(name)
	recordings[name] = nil
	saveAllRecordingsToFile()
end

local function renameRecording(oldName, newName)
	if recordings[oldName] and not recordings[newName] then
		local data = recordings[oldName]
		
		local parts = string.split(data, "|")
		parts[1] = newName
		local newData = table.concat(parts, "|")
		
		recordings[newName] = newData
		recordings[oldName] = nil
		
		saveAllRecordingsToFile()
		
		print("‚úèÔ∏è Renamed: " .. oldName .. " ‚Üí " .. newName)
		return true
	end
	return false
end

local function getRecordingCount()
	local c = 0
	for _ in pairs(recordings) do c = c + 1 end
	return c
end

-- ================= BERSIHKAN UI LAMA =================
for _, gui in pairs(PlayerGui:GetChildren()) do
    if gui.Name:match("FedlyHub") or gui.Name == "AutoWalkUI" then
        gui:Destroy()
    end
end

-- ================= SCREEN GUI =================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FedlyAutoWalk"
screenGui.IgnoreGuiInset = true
screenGui.ResetOnSpawn = false
screenGui.Parent = PlayerGui

-- ================= FLOATING ICON =================
local floatBtn = Instance.new("ImageButton")
floatBtn.Size = isMobile and UDim2.new(0, 56, 0, 56) or UDim2.new(0, 66, 0, 66)
floatBtn.Position = UDim2.new(0.05, 0, 0.12, 0)
floatBtn.BackgroundColor3 = Color3.fromRGB(99, 102, 241)
floatBtn.Image = "rbxassetid://6031068433"
floatBtn.ImageTransparency = 0.1
floatBtn.Parent = screenGui
Instance.new("UICorner", floatBtn).CornerRadius = UDim.new(0.5, 0) -- Perfect circle

-- Gradient
local floatGradient = Instance.new("UIGradient", floatBtn)
floatGradient.Color = ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(139, 92, 246)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(59, 130, 246))
}
floatGradient.Rotation = 135

local floatStroke = Instance.new("UIStroke", floatBtn)
floatStroke.Color = Color3.fromRGB(167, 139, 250)
floatStroke.Thickness = 2
floatStroke.Transparency = 0.5

-- Draggable
local dragging = false
local dragStart = nil
local startPos = nil
local dragThreshold = 10

floatBtn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
        dragStart = input.Position
        startPos = floatBtn.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragStart and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = (input.Position - dragStart).Magnitude
        if delta > dragThreshold then
            dragging = true
            local moveDelta = input.Position - dragStart
            floatBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + moveDelta.X, startPos.Y.Scale, startPos.Y.Offset + moveDelta.Y)
        end
    end
end)

floatBtn.InputEnded:Connect(function() 
    dragStart = nil
    dragging = false
end)

-- ================= MAIN MENU FRAME (LANDSCAPE) =================
local mainFrame = Instance.new("Frame")
mainFrame.Size = isMobile and UDim2.new(0, 340, 0, 280) or UDim2.new(0, 700, 0, 400)
mainFrame.Position = isMobile and UDim2.new(0.5, 0, 0.5, 0) or UDim2.new(0.5, 0, 0.5, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 23, 32)
mainFrame.BackgroundTransparency = 0.2
mainFrame.Visible = true  -- ‚úÖ Langsung tampil, tidak perlu login
mainFrame.Active = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 14)

local mainStroke = Instance.new("UIStroke", mainFrame)
mainStroke.Color = Color3.fromRGB(88, 101, 242)
mainStroke.Thickness = 2

-- Make main frame draggable
local mainDragging = false
local mainDragStart = nil
local mainStartPos = nil

mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        mainDragging = true
        mainDragStart = input.Position
        mainStartPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                mainDragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if mainDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - mainDragStart
        mainFrame.Position = UDim2.new(
            mainStartPos.X.Scale,
            mainStartPos.X.Offset + delta.X,
            mainStartPos.Y.Scale,
            mainStartPos.Y.Offset + delta.Y
        )
    end
end)

-- Header
local mainHeader = Instance.new("Frame", mainFrame)
mainHeader.Size = UDim2.new(1, 0, 0, isMobile and 45 or 60)
mainHeader.BackgroundColor3 = Color3.fromRGB(30, 34, 45)
mainHeader.BackgroundTransparency = 0.3
Instance.new("UICorner", mainHeader).CornerRadius = UDim.new(0, 14)

local mainTitle = Instance.new("TextLabel", mainHeader)
mainTitle.Size = UDim2.new(1, 0, 1, 0)
mainTitle.BackgroundTransparency = 1
mainTitle.Text = "Fedly Hub - Auto Walk"
mainTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
mainTitle.Font = Enum.Font.GothamBold
mainTitle.TextSize = isMobile and 15 or 24

-- Menu List Container
local menuListFrame = Instance.new("ScrollingFrame", mainFrame)
menuListFrame.Name = "MenuList"
menuListFrame.Size = UDim2.new(1, -20, 1, isMobile and -60 or -80)
menuListFrame.Position = UDim2.new(0, 10, 0, isMobile and 50 or 65)
menuListFrame.BackgroundTransparency = 1
menuListFrame.BorderSizePixel = 0
menuListFrame.ScrollBarThickness = 0
menuListFrame.ScrollBarImageColor3 = Color3.fromRGB(88, 101, 242)
menuListFrame.ScrollingDirection = Enum.ScrollingDirection.Y
menuListFrame.Visible = true

local menuLayout = Instance.new("UIListLayout", menuListFrame)
menuLayout.Padding = UDim.new(0, isMobile and 8 or 12)
menuLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
menuLayout.VerticalAlignment = Enum.VerticalAlignment.Center

local menuPadding = Instance.new("UIPadding", menuListFrame)
menuPadding.PaddingTop = UDim.new(0, isMobile and 12 or 20)
menuPadding.PaddingBottom = UDim.new(0, isMobile and 12 or 20)

-- Content Frames (Hidden by default)
local mountContent = Instance.new("Frame", mainFrame)
mountContent.Name = "MountContent"
mountContent.Size = UDim2.new(1, -20, 1, isMobile and -60 or -80)
mountContent.Position = UDim2.new(0, 10, 0, isMobile and 50 or 65)
mountContent.BackgroundTransparency = 1
mountContent.Visible = false

local recorderContent = Instance.new("Frame", mainFrame)
recorderContent.Name = "RecorderContent"
recorderContent.Size = UDim2.new(1, -20, 1, isMobile and -60 or -80)
recorderContent.Position = UDim2.new(0, 10, 0, isMobile and 50 or 65)
recorderContent.BackgroundTransparency = 1
recorderContent.Visible = false

local playbackContent = Instance.new("Frame", mainFrame)
playbackContent.Name = "PlaybackContent"
playbackContent.Size = UDim2.new(1, -20, 1, -20)
playbackContent.Position = UDim2.new(0, 10, 0, 10)
playbackContent.BackgroundTransparency = 1
playbackContent.Visible = false

local proContent = Instance.new("Frame", mainFrame)
proContent.Name = "ProContent"
proContent.Size = UDim2.new(1, -20, 1, isMobile and -60 or -80)
proContent.Position = UDim2.new(0, 10, 0, isMobile and 50 or 65)
proContent.BackgroundTransparency = 1
proContent.Visible = false

-- Function to create menu button
local function createMenuButton(icon, title, description)
	local btn = Instance.new("TextButton", menuListFrame)
	btn.Size = UDim2.new(0.96, 0, 0, isMobile and 55 or 75)
	btn.BackgroundColor3 = Color3.fromRGB(30, 34, 45)
	btn.BackgroundTransparency = 0.3
	btn.BorderSizePixel = 0
	btn.Text = ""
	btn.AutoButtonColor = false
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)
	
	local btnStroke = Instance.new("UIStroke", btn)
	btnStroke.Color = Color3.fromRGB(60, 65, 80)
	btnStroke.Thickness = 1
	
	local iconLabel = Instance.new("TextLabel", btn)
	iconLabel.Size = UDim2.new(0, isMobile and 40 or 55, 1, 0)
	iconLabel.Position = UDim2.new(0, isMobile and 8 or 12, 0, 0)
	iconLabel.BackgroundTransparency = 1
	iconLabel.Text = icon
	iconLabel.TextSize = isMobile and 22 or 32
	iconLabel.Font = Enum.Font.GothamBold
	
	local titleLabel = Instance.new("TextLabel", btn)
	titleLabel.Size = UDim2.new(1, isMobile and -100 or -140, 0, isMobile and 20 or 28)
	titleLabel.Position = UDim2.new(0, isMobile and 50 or 70, 0, isMobile and 8 or 12)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Text = title
	titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	titleLabel.TextSize = isMobile and 13 or 18
	titleLabel.Font = Enum.Font.GothamBold
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	
	local descLabel = Instance.new("TextLabel", btn)
	descLabel.Size = UDim2.new(1, isMobile and -100 or -140, 0, isMobile and 16 or 22)
	descLabel.Position = UDim2.new(0, isMobile and 50 or 70, 0, isMobile and 28 or 40)
	descLabel.BackgroundTransparency = 1
	descLabel.Text = description
	descLabel.TextColor3 = Color3.fromRGB(150, 155, 170)
	descLabel.TextSize = isMobile and 10 or 13
	descLabel.Font = Enum.Font.Gotham
	descLabel.TextXAlignment = Enum.TextXAlignment.Left
	
	local arrow = Instance.new("TextLabel", btn)
	arrow.Size = UDim2.new(0, isMobile and 30 or 40, 1, 0)
	arrow.Position = UDim2.new(1, isMobile and -35 or -45, 0, 0)
	arrow.BackgroundTransparency = 1
	arrow.Text = "‚Ä∫"
	arrow.TextColor3 = Color3.fromRGB(88, 101, 242)
	arrow.TextSize = isMobile and 28 or 38
	arrow.Font = Enum.Font.GothamBold
	
	-- Hover effect
	btn.MouseEnter:Connect(function()
		btnStroke.Color = Color3.fromRGB(88, 101, 242)
		btn.BackgroundTransparency = 0.1
	end)
	
	btn.MouseLeave:Connect(function()
		btnStroke.Color = Color3.fromRGB(60, 65, 80)
		btn.BackgroundTransparency = 0.3
	end)
	
	return btn
end

-- Create menu buttons
local recorderMenuBtn = createMenuButton("üé¨", "Recorder", "Record pergerakan + animasi")
local playbackMenuBtn = createMenuButton("‚ñ∂Ô∏è", "Playback", "Play recording dengan animasi")

-- Update canvas size
task.defer(function()
	menuListFrame.CanvasSize = UDim2.new(0, 0, 0, menuLayout.AbsoluteContentSize.Y + (isMobile and 16 or 24))
end)

-- Back button function
local function createBackButton(parentFrame)
	local backBtn = Instance.new("TextButton", parentFrame)
	backBtn.Size = UDim2.new(0, isMobile and 70 or 90, 0, isMobile and 28 or 35)
	backBtn.Position = UDim2.new(0, 0, 0, 0)
	backBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
	backBtn.BorderSizePixel = 0
	backBtn.Text = "‚Äπ Back"
	backBtn.TextColor3 = Color3.new(1, 1, 1)
	backBtn.TextSize = isMobile and 11 or 14
	backBtn.Font = Enum.Font.GothamBold
	Instance.new("UICorner", backBtn).CornerRadius = UDim.new(0, 8)
	
	backBtn.MouseButton1Click:Connect(function()
		recorderContent.Visible = false
		playbackContent.Visible = false
		mainHeader.Visible = true
		menuListFrame.Visible = true
	end)
	
	return backBtn
end

-- Menu button click handlers
recorderMenuBtn.MouseButton1Click:Connect(function()
	menuListFrame.Visible = false
	mainHeader.Visible = true
	recorderContent.Visible = true
end)

playbackMenuBtn.MouseButton1Click:Connect(function()
	menuListFrame.Visible = false
	mainHeader.Visible = false
	playbackContent.Visible = true
end)
end)

-- ================= MOUNT TAB CONTENT =================
-- Back, Animasi, Loop, Search, Refresh dalam 1 baris (compact)
local topControlsFrame = Instance.new("Frame", mountContent)
topControlsFrame.Size = UDim2.new(1, 0, 0, isMobile and 35 or 40)
topControlsFrame.Position = UDim2.new(0, 0, 0, 0)
topControlsFrame.BackgroundTransparency = 1

-- Back Button
local backBtn = Instance.new("TextButton", topControlsFrame)
backBtn.Size = UDim2.new(0.15, -3, 1, isMobile and -8 or -10)
backBtn.Position = UDim2.new(0, 0, 0, isMobile and 4 or 5)
backBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
backBtn.BorderSizePixel = 0
backBtn.Text = "‚Äπ"
backBtn.TextColor3 = Color3.new(1, 1, 1)
backBtn.TextSize = isMobile and 12 or 14
backBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", backBtn).CornerRadius = UDim.new(0, 5)

backBtn.MouseButton1Click:Connect(function()
	mountContent.Visible = false
	recorderContent.Visible = false
	playbackContent.Visible = false
	mainHeader.Visible = true
	menuListFrame.Visible = true
end)

-- Animation Dropdown
local mountAnimDropdown = Instance.new("TextButton", topControlsFrame)
mountAnimDropdown.Size = UDim2.new(0.22, -3, 1, isMobile and -8 or -10)
mountAnimDropdown.Position = UDim2.new(0.16, 0, 0, isMobile and 4 or 5)
mountAnimDropdown.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
mountAnimDropdown.BorderSizePixel = 0
mountAnimDropdown.Text = "‚ñº " .. selectedAnimPackage
mountAnimDropdown.TextColor3 = Color3.new(1, 1, 1)
mountAnimDropdown.TextSize = isMobile and 7 or 9
mountAnimDropdown.Font = Enum.Font.Gotham
mountAnimDropdown.TextXAlignment = Enum.TextXAlignment.Left
Instance.new("UICorner", mountAnimDropdown).CornerRadius = UDim.new(0, 5)

local animPadding = Instance.new("UIPadding", mountAnimDropdown)
animPadding.PaddingLeft = UDim.new(0, 5)

-- Loop Toggle
local mountLoopToggle = Instance.new("TextButton", topControlsFrame)
mountLoopToggle.Size = UDim2.new(0.15, -3, 1, isMobile and -8 or -10)
mountLoopToggle.Position = UDim2.new(0.39, 0, 0, isMobile and 4 or 5)
mountLoopToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
mountLoopToggle.BorderSizePixel = 0
mountLoopToggle.Text = "Loop"
mountLoopToggle.TextColor3 = Color3.fromRGB(200, 200, 200)
mountLoopToggle.TextSize = isMobile and 7 or 9
mountLoopToggle.Font = Enum.Font.GothamBold
Instance.new("UICorner", mountLoopToggle).CornerRadius = UDim.new(0, 5)

mountLoopToggle.MouseButton1Click:Connect(function()
	loopEnabled = not loopEnabled
	mountLoopToggle.Text = loopEnabled and "Loop: ON" or "Loop"
	mountLoopToggle.BackgroundColor3 = loopEnabled and Color3.fromRGB(88, 101, 242) or Color3.fromRGB(60, 60, 60)
	mountLoopToggle.TextColor3 = loopEnabled and Color3.new(1, 1, 1) or Color3.fromRGB(200, 200, 200)
end)

-- Search Box
local searchBox = Instance.new("TextBox", topControlsFrame)
searchBox.Size = UDim2.new(0.3, -3, 1, isMobile and -8 or -10)
searchBox.Position = UDim2.new(0.55, 0, 0, isMobile and 4 or 5)
searchBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
searchBox.BorderSizePixel = 0
searchBox.PlaceholderText = "üîç"
searchBox.Text = ""
searchBox.TextColor3 = Color3.new(1, 1, 1)
searchBox.TextSize = isMobile and 7 or 9
searchBox.Font = Enum.Font.Gotham
searchBox.TextXAlignment = Enum.TextXAlignment.Left
searchBox.ClearTextOnFocus = false
Instance.new("UICorner", searchBox).CornerRadius = UDim.new(0, 5)

local searchPadding = Instance.new("UIPadding", searchBox)
searchPadding.PaddingLeft = UDim.new(0, 5)

-- Refresh Button
local refreshBtn = Instance.new("TextButton", topControlsFrame)
refreshBtn.Size = UDim2.new(0.13, -3, 1, isMobile and -8 or -10)
refreshBtn.Position = UDim2.new(0.87, 0, 0, isMobile and 4 or 5)
refreshBtn.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
refreshBtn.BorderSizePixel = 0
refreshBtn.Text = "üîÑ"
refreshBtn.TextColor3 = Color3.new(1, 1, 1)
refreshBtn.TextSize = isMobile and 10 or 12
refreshBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", refreshBtn).CornerRadius = UDim.new(0, 5)

refreshBtn.MouseButton1Click:Connect(function()
	loadScriptLibrary()
end)

-- Dropdown menu for animation (mount tab)
local mountDropdownMenu = Instance.new("ScrollingFrame", mountContent)
mountDropdownMenu.Size = UDim2.new(0.22, -3, 0, 0)
mountDropdownMenu.Position = UDim2.new(0.16, 0, 0, isMobile and 37 or 42)
mountDropdownMenu.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mountDropdownMenu.BorderSizePixel = 0
mountDropdownMenu.Visible = false
mountDropdownMenu.ClipsDescendants = true
mountDropdownMenu.ZIndex = 10
mountDropdownMenu.ScrollBarThickness = 0
mountDropdownMenu.CanvasSize = UDim2.new(0, 0, 0, 0)
mountDropdownMenu.ScrollingDirection = Enum.ScrollingDirection.Y
mountDropdownMenu.ScrollingEnabled = true
mountDropdownMenu.Active = true
Instance.new("UICorner", mountDropdownMenu).CornerRadius = UDim.new(0, 5)

local mountDropLayout = Instance.new("UIListLayout", mountDropdownMenu)
mountDropLayout.Padding = UDim.new(0, 2)
mountDropLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left

local mountPackageNames = {}
for name in pairs(AnimationPackages) do
	table.insert(mountPackageNames, name)
end
table.sort(mountPackageNames)

local mountDropdownOpen = false
local mountMaxDropdownHeight = isMobile and 196 or 210

for _, packageName in ipairs(mountPackageNames) do
	local item = Instance.new("TextButton", mountDropdownMenu)
	item.Size = UDim2.new(1, -4, 0, isMobile and 26 or 28)
	item.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	item.BorderSizePixel = 0
	item.Text = packageName
	item.TextColor3 = Color3.new(1, 1, 1)
	item.TextSize = isMobile and 7 or 9
	item.Font = Enum.Font.Gotham
	item.TextXAlignment = Enum.TextXAlignment.Left
	item.ZIndex = 10
	item.AutoButtonColor = true
	
	local itemPadding = Instance.new("UIPadding", item)
	itemPadding.PaddingLeft = UDim.new(0, 6)
	itemPadding.PaddingRight = UDim.new(0, 2)
	
	item.MouseEnter:Connect(function()
		item.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	end)
	
	item.MouseLeave:Connect(function()
		item.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	end)
	
	item.MouseButton1Click:Connect(function()
		selectedAnimPackage = packageName
		mountAnimDropdown.Text = "‚ñº " .. packageName
		mountDropdownMenu.Visible = false
		mountDropdownOpen = false
		print("üé≠ Mount animation changed to: " .. packageName)
	end)
end

task.defer(function()
	local totalHeight = mountDropLayout.AbsoluteContentSize.Y + 4
	mountDropdownMenu.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
end)

mountAnimDropdown.MouseButton1Click:Connect(function()
	mountDropdownOpen = not mountDropdownOpen
	mountDropdownMenu.Visible = mountDropdownOpen
	
	if mountDropdownOpen then
		local itemCount = #mountPackageNames
		local itemHeight = isMobile and 28 or 30
		local totalHeight = itemCount * itemHeight
		local finalHeight = math.min(totalHeight, mountMaxDropdownHeight)
		
		mountDropdownMenu:TweenSize(
			UDim2.new(0.22, -3, 0, finalHeight),
			Enum.EasingDirection.Out,
			Enum.EasingStyle.Quad,
			0.2,
			true
		)
	else
		mountDropdownMenu:TweenSize(
			UDim2.new(0.22, -3, 0, 0),
			Enum.EasingDirection.In,
			Enum.EasingStyle.Quad,
			0.15,
			true
		)
	end
end)

-- Vertical scroll for mount list
local mountScroll = Instance.new("ScrollingFrame", mountContent)
mountScroll.Size = UDim2.new(1, 0, 1, isMobile and -40 or -45)
mountScroll.Position = UDim2.new(0, 0, 0, isMobile and 38 or 43)
mountScroll.BackgroundColor3 = Color3.fromRGB(25, 28, 38)
mountScroll.BackgroundTransparency = 0.4
mountScroll.BorderSizePixel = 0
mountScroll.ScrollBarThickness = 3
mountScroll.ScrollBarImageColor3 = Color3.fromRGB(88, 101, 242)
mountScroll.Visible = false
Instance.new("UICorner", mountScroll).CornerRadius = UDim.new(0, 10)

local mountLayout = Instance.new("UIListLayout", mountScroll)
mountLayout.Padding = UDim.new(0, isMobile and 5 or 10)
mountLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local mountPadding = Instance.new("UIPadding", mountScroll)
mountPadding.PaddingTop = UDim.new(0, isMobile and 6 or 12)
mountPadding.PaddingBottom = UDim.new(0, isMobile and 6 or 12)

-- ================= RECORDER TAB CONTENT =================
createBackButton(recorderContent)
local recStatus = Instance.new("TextLabel", recorderContent)
recStatus.Size = UDim2.new(1, 0, 0, isMobile and 22 or 28)
recStatus.Position = UDim2.new(0, 0, 0, isMobile and 33 or 40)
recStatus.BackgroundTransparency = 1
recStatus.Text = "Status: Idle"
recStatus.TextColor3 = Color3.fromRGB(200, 200, 200)
recStatus.TextSize = isMobile and 11 or 14
recStatus.Font = Enum.Font.Gotham
recStatus.TextXAlignment = Enum.TextXAlignment.Left

local recFrames = Instance.new("TextLabel", recorderContent)
recFrames.Size = UDim2.new(1, 0, 0, isMobile and 18 or 23)
recFrames.Position = UDim2.new(0, 0, 0, isMobile and 53 or 66)
recFrames.BackgroundTransparency = 1
recFrames.Text = "Frames: 0"
recFrames.TextColor3 = Color3.fromRGB(150, 150, 150)
recFrames.TextSize = isMobile and 10 or 12
recFrames.Font = Enum.Font.Gotham
recFrames.TextXAlignment = Enum.TextXAlignment.Left

local function recBtn(name, text, pos, color)
	local b = Instance.new("TextButton", recorderContent)
	b.Name = name
	b.Size = UDim2.new(0.48, 0, 0, isMobile and 32 or 40)
	b.Position = pos
	b.BackgroundColor3 = color
	b.BorderSizePixel = 0
	b.Text = text
	b.TextColor3 = Color3.new(1, 1, 1)
	b.TextSize = isMobile and 12 or 16
	b.Font = Enum.Font.GothamBold
	local c = Instance.new("UICorner")
	c.CornerRadius = UDim.new(0, 8)
	c.Parent = b
	return b
end

local recordBtn = recBtn("Rec", "üî¥ Record", UDim2.new(0, 0, 0, isMobile and 75 or 95), Color3.fromRGB(220, 50, 50))
local stopBtn = recBtn("Stop", "‚èπÔ∏è Stop", UDim2.new(0.52, 0, 0, isMobile and 75 or 95), Color3.fromRGB(200, 100, 50))
local saveBtn = recBtn("Save", "üíæ Save", UDim2.new(0, 0, 0, isMobile and 115 or 145), Color3.fromRGB(50, 150, 220))

-- ================= PRO FEATURES TAB CONTENT =================
createBackButton(proContent)

-- Status labels
local proStatus = Instance.new("TextLabel", proContent)
proStatus.Size = UDim2.new(1, 0, 0, isMobile and 22 or 28)
proStatus.Position = UDim2.new(0, 0, 0, isMobile and 33 or 40)
proStatus.BackgroundTransparency = 1
proStatus.Text = "Pro Features"
proStatus.TextColor3 = Color3.fromRGB(200, 200, 200)
proStatus.TextSize = isMobile and 13 or 16
proStatus.Font = Enum.Font.GothamBold
proStatus.TextXAlignment = Enum.TextXAlignment.Left

-- Feature buttons
local function createProButton(name, text, pos, color)
	local b = Instance.new("TextButton", proContent)
	b.Name = name
	b.Size = UDim2.new(1, 0, 0, isMobile and 40 or 50)
	b.Position = pos
	b.BackgroundColor3 = color
	b.BorderSizePixel = 0
	b.Text = text
	b.TextColor3 = Color3.new(1, 1, 1)
	b.TextSize = isMobile and 13 or 16
	b.Font = Enum.Font.GothamBold
	local c = Instance.new("UICorner")
	c.CornerRadius = UDim.new(0, 10)
	c.Parent = b
	return b
end

local doubleJumpBtn = createProButton("DoubleJump", "üöÄ Double Jump: OFF", UDim2.new(0, 0, 0, isMobile and 60 or 75), Color3.fromRGB(99, 102, 241))
local noclipBtn = createProButton("NoClip", "üëª No Clip: OFF", UDim2.new(0, 0, 0, isMobile and 110 or 135), Color3.fromRGB(59, 130, 246))
local espBtn = createProButton("ESP", "üëÅÔ∏è ESP: OFF", UDim2.new(0, 0, 0, isMobile and 160 or 195), Color3.fromRGB(236, 72, 153))

-- Double Jump variables
local doubleJumpEnabled = false
local canDoubleJump = false
local hasDoubleJumped = false
local jumpDebounce = false
local doubleJumpConnections = {}

-- No Clip variables
local noclipEnabled = false
local noclipConnections = {}

-- ESP variables
local espEnabled = false
local espBoxes = {}

-- ================= DOUBLE JUMP LOGIC =================
local function enableDoubleJump()
	if doubleJumpEnabled then return end
	doubleJumpEnabled = true
	doubleJumpBtn.Text = "üöÄ Double Jump: ON"
	doubleJumpBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
	
	local char = Player.Character
	if not char then return end
	local humanoid = char:FindFirstChild("Humanoid")
	if not humanoid then return end
	
	-- State changed
	table.insert(doubleJumpConnections, humanoid.StateChanged:Connect(function(oldState, newState)
		if newState == Enum.HumanoidStateType.Landed then
			canDoubleJump = false
			hasDoubleJumped = false
			jumpDebounce = false
		elseif newState == Enum.HumanoidStateType.Freefall then
			task.wait(0.1)
			if not hasDoubleJumped then
				canDoubleJump = true
			end
		end
	end))
	
	-- Jump monitoring
	task.spawn(function()
		local lastJumpState = false
		while doubleJumpEnabled and task.wait(0.05) do
			if humanoid and humanoid.Parent then
				local currentJumpState = humanoid.Jump
				
				if currentJumpState and not lastJumpState then
					if canDoubleJump and not hasDoubleJumped and not jumpDebounce then
						jumpDebounce = true
						hasDoubleJumped = true
						canDoubleJump = false
						
						humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
						
						task.wait(0.2)
						jumpDebounce = false
					end
				end
				
				lastJumpState = currentJumpState
			end
		end
	end)
	
	print("‚úÖ Double Jump enabled")
end

local function disableDoubleJump()
	if not doubleJumpEnabled then return end
	doubleJumpEnabled = false
	doubleJumpBtn.Text = "üöÄ Double Jump: OFF"
	doubleJumpBtn.BackgroundColor3 = Color3.fromRGB(99, 102, 241)
	
	for _, conn in ipairs(doubleJumpConnections) do
		conn:Disconnect()
	end
	doubleJumpConnections = {}
	
	canDoubleJump = false
	hasDoubleJumped = false
	jumpDebounce = false
	
	print("‚ùå Double Jump disabled")
end

-- ================= NO CLIP LOGIC =================
local function enableNoClip()
	if noclipEnabled then return end
	noclipEnabled = true
	noclipBtn.Text = "üëª No Clip: ON"
	noclipBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
	
	local char = Player.Character
	if not char then return end
	
	-- Function to disable collision
	local function disableCollision()
		for _, part in pairs(char:GetDescendants()) do
			if part:IsA("BasePart") then
				part.CanCollide = false
			end
		end
	end
	
	-- Disable collision every frame
	table.insert(noclipConnections, RunService.Stepped:Connect(function()
		if noclipEnabled then
			disableCollision()
		end
	end))
	
	-- Handle new parts added
	table.insert(noclipConnections, char.DescendantAdded:Connect(function(descendant)
		if noclipEnabled and descendant:IsA("BasePart") then
			descendant.CanCollide = false
		end
	end))
	
	print("‚úÖ No Clip enabled - Walk through walls!")
end

local function disableNoClip()
	if not noclipEnabled then return end
	noclipEnabled = false
	noclipBtn.Text = "üëª No Clip: OFF"
	noclipBtn.BackgroundColor3 = Color3.fromRGB(59, 130, 246)
	
	-- Disconnect all
	for _, conn in ipairs(noclipConnections) do
		conn:Disconnect()
	end
	noclipConnections = {}
	
	-- Re-enable collision
	local char = Player.Character
	if char then
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if hrp then
			for _, obj in ipairs(hrp:GetChildren()) do
				if obj:IsA("BodyVelocity") or obj:IsA("BodyGyro") then
					obj:Destroy()
				end
			end
		end
	end
	
	print("‚ùå Fly disabled")
end

-- ================= ESP LOGIC =================
local function createESPBox(player)
	if player == Player then return end
	
	local char = player.Character
	if not char then return end
	
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	
	-- Create BillboardGui
	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ESP_" .. player.Name
	billboard.Adornee = hrp
	billboard.Size = UDim2.new(4, 0, 5, 0)
	billboard.StudsOffset = Vector3.new(0, 0, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = hrp
	
	-- Box frame
	local box = Instance.new("Frame", billboard)
	box.Size = UDim2.new(1, 0, 1, 0)
	box.BackgroundTransparency = 0.8
	box.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
	box.BorderSizePixel = 0
	
	local stroke = Instance.new("UIStroke", box)
	stroke.Color = Color3.fromRGB(255, 0, 0)
	stroke.Thickness = 2
	
	-- Name label
	local nameLabel = Instance.new("TextLabel", billboard)
	nameLabel.Size = UDim2.new(1, 0, 0, 20)
	nameLabel.Position = UDim2.new(0, 0, 0, -25)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Text = player.Name
	nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	nameLabel.TextSize = 14
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.TextStrokeTransparency = 0.5
	
	espBoxes[player.Name] = billboard
end

local function enableESP()
	if espEnabled then return end
	espEnabled = true
	espBtn.Text = "üëÅÔ∏è ESP: ON"
	espBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
	
	-- Create ESP for all players
	for _, player in ipairs(Players:GetPlayers()) do
		if player.Character then
			createESPBox(player)
		end
	end
	
	-- Handle new players
	Players.PlayerAdded:Connect(function(player)
		if not espEnabled then return end
		player.CharacterAdded:Connect(function()
			if espEnabled then
				task.wait(0.5)
				createESPBox(player)
			end
		end)
	end)
	
	-- Handle character respawn
	for _, player in ipairs(Players:GetPlayers()) do
		player.CharacterAdded:Connect(function()
			if espEnabled then
				task.wait(0.5)
				createESPBox(player)
			end
		end)
	end
	
	print("‚úÖ ESP enabled")
end

local function disableESP()
	if not espEnabled then return end
	espEnabled = false
	espBtn.Text = "üëÅÔ∏è ESP: OFF"
	espBtn.BackgroundColor3 = Color3.fromRGB(236, 72, 153)
	
	-- Remove all ESP boxes
	for _, billboard in pairs(espBoxes) do
		if billboard and billboard.Parent then
			billboard:Destroy()
		end
	end
	espBoxes = {}
	
	print("‚ùå ESP disabled")
end

-- Button click handlers
doubleJumpBtn.MouseButton1Click:Connect(function()
	if doubleJumpEnabled then
		disableDoubleJump()
	else
		enableDoubleJump()
	end
end)

noclipBtn.MouseButton1Click:Connect(function()
	if noclipEnabled then
		disableNoClip()
	else
		enableNoClip()
	end
end)

espBtn.MouseButton1Click:Connect(function()
	if espEnabled then
		disableESP()
	else
		enableESP()
	end
end)

-- ================= PLAYBACK TAB CONTENT =================
-- Back, Animation, Loop dalam 1 baris (compact)
local topControlsFrame = Instance.new("Frame", playbackContent)
topControlsFrame.Size = UDim2.new(1, 0, 0, isMobile and 35 or 40)
topControlsFrame.Position = UDim2.new(0, 0, 0, 0)
topControlsFrame.BackgroundTransparency = 1

-- Back Button (kiri)
local backBtn = Instance.new("TextButton", topControlsFrame)
backBtn.Size = UDim2.new(0.3, -5, 1, isMobile and -8 or -10)
backBtn.Position = UDim2.new(0, 0, 0, isMobile and 4 or 5)
backBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
backBtn.BorderSizePixel = 0
backBtn.Text = "‚Äπ Back"
backBtn.TextColor3 = Color3.new(1, 1, 1)
backBtn.TextSize = isMobile and 9 or 11
backBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", backBtn).CornerRadius = UDim.new(0, 5)

backBtn.MouseButton1Click:Connect(function()
	mountContent.Visible = false
	recorderContent.Visible = false
	playbackContent.Visible = false
	mainHeader.Visible = true
	menuListFrame.Visible = true
end)

-- Animation Dropdown (tengah)
local animDropdown = Instance.new("TextButton", topControlsFrame)
animDropdown.Size = UDim2.new(0.38, -5, 1, isMobile and -8 or -10)
animDropdown.Position = UDim2.new(0.31, 0, 0, isMobile and 4 or 5)
animDropdown.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
animDropdown.BorderSizePixel = 0
animDropdown.Text = "‚ñº " .. selectedAnimPackage
animDropdown.TextColor3 = Color3.new(1, 1, 1)
animDropdown.TextSize = isMobile and 8 or 10
animDropdown.Font = Enum.Font.Gotham
animDropdown.TextXAlignment = Enum.TextXAlignment.Left
Instance.new("UICorner", animDropdown).CornerRadius = UDim.new(0, 5)

local animPadding = Instance.new("UIPadding", animDropdown)
animPadding.PaddingLeft = UDim.new(0, 8)

-- Loop Toggle (kanan)
local loopToggle = Instance.new("TextButton", topControlsFrame)
loopToggle.Size = UDim2.new(0.3, -5, 1, isMobile and -8 or -10)
loopToggle.Position = UDim2.new(0.7, 0, 0, isMobile and 4 or 5)
loopToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
loopToggle.BorderSizePixel = 0
loopToggle.Text = "Loop: OFF"
loopToggle.TextColor3 = Color3.fromRGB(200, 200, 200)
loopToggle.TextSize = isMobile and 8 or 10
loopToggle.Font = Enum.Font.GothamBold
Instance.new("UICorner", loopToggle).CornerRadius = UDim.new(0, 5)

-- Dropdown menu (compact, tidak keluar border)
local dropdownMenu = Instance.new("ScrollingFrame", playbackContent)
dropdownMenu.Size = UDim2.new(0.38, -5, 0, 0)
dropdownMenu.Position = UDim2.new(0.31, 0, 0, isMobile and 37 or 42)
dropdownMenu.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
dropdownMenu.BorderSizePixel = 0
dropdownMenu.Visible = false
dropdownMenu.ClipsDescendants = true
dropdownMenu.ZIndex = 10
dropdownMenu.ScrollBarThickness = 0
dropdownMenu.CanvasSize = UDim2.new(0, 0, 0, 0)
dropdownMenu.ScrollingDirection = Enum.ScrollingDirection.Y
dropdownMenu.ScrollingEnabled = true
dropdownMenu.Active = true
Instance.new("UICorner", dropdownMenu).CornerRadius = UDim.new(0, 5)

local dropLayout = Instance.new("UIListLayout", dropdownMenu)
dropLayout.Padding = UDim.new(0, 2)
dropLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left

local packageNames = {}
for name in pairs(AnimationPackages) do
	table.insert(packageNames, name)
end
table.sort(packageNames)

-- Deklarasi variabel dropdown state di awal
local dropdownOpen = false
local maxDropdownHeight = isMobile and 196 or 210

for _, packageName in ipairs(packageNames) do
	local item = Instance.new("TextButton", dropdownMenu)
	item.Size = UDim2.new(1, -4, 0, isMobile and 26 or 28)
	item.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	item.BorderSizePixel = 0
	item.Text = packageName
	item.TextColor3 = Color3.new(1, 1, 1)
	item.TextSize = isMobile and 8 or 10
	item.Font = Enum.Font.Gotham
	item.TextXAlignment = Enum.TextXAlignment.Left
	item.ZIndex = 10
	item.AutoButtonColor = true
	
	local itemPadding = Instance.new("UIPadding", item)
	itemPadding.PaddingLeft = UDim.new(0, 6)
	itemPadding.PaddingRight = UDim.new(0, 2)
	
	item.MouseEnter:Connect(function()
		item.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	end)
	
	item.MouseLeave:Connect(function()
		item.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	end)
	
	item.MouseButton1Click:Connect(function()
		selectedAnimPackage = packageName
		animDropdown.Text = "‚ñº " .. packageName
		dropdownMenu.Visible = false
		dropdownOpen = false
		print("üé≠ Animation changed to: " .. packageName)
	end)
end

-- Update canvas size setelah semua item ditambahkan
task.defer(function()
	local totalHeight = dropLayout.AbsoluteContentSize.Y + 4
	dropdownMenu.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
end)

animDropdown.MouseButton1Click:Connect(function()
	dropdownOpen = not dropdownOpen
	dropdownMenu.Visible = dropdownOpen
	
	if dropdownOpen then
		local itemCount = #packageNames
		local itemHeight = isMobile and 28 or 30
		local totalHeight = itemCount * itemHeight
		local finalHeight = math.min(totalHeight, maxDropdownHeight)
		
		dropdownMenu:TweenSize(
			UDim2.new(0.38, -5, 0, finalHeight),
			Enum.EasingDirection.Out,
			Enum.EasingStyle.Quad,
			0.2,
			true
		)
		
		-- Update canvas size setelah tween selesai
		task.spawn(function()
			task.wait(0.25)
			dropdownMenu.CanvasSize = UDim2.new(0, 0, 0, dropLayout.AbsoluteContentSize.Y + 4)
		end)
	else
		dropdownMenu:TweenSize(
			UDim2.new(0.38, -5, 0, 0),
			Enum.EasingDirection.Out,
			Enum.EasingStyle.Quad,
			0.2,
			true
		)
	end
end)

loopToggle.MouseButton1Click:Connect(function()
	loopEnabled = not loopEnabled
	if loopEnabled then
		loopToggle.Text = "Loop: ON"
		loopToggle.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
		loopToggle.TextColor3 = Color3.new(1, 1, 1)
		print("üîÅ Loop enabled")
	else
		loopToggle.Text = "Loop: OFF"
		loopToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
		loopToggle.TextColor3 = Color3.fromRGB(200, 200, 200)
		print("‚èπÔ∏è Loop disabled")
	end
end)

-- Recordings List
local playLabel = Instance.new("TextLabel", playbackContent)
playLabel.Size = UDim2.new(1, 0, 0, isMobile and 14 or 18)
playLabel.Position = UDim2.new(0, 0, 0, isMobile and 38 or 43)
playLabel.BackgroundTransparency = 1
playLabel.Text = "Saved Recordings: (0)"
playLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
playLabel.TextSize = isMobile and 9 or 12
playLabel.Font = Enum.Font.GothamBold
playLabel.TextXAlignment = Enum.TextXAlignment.Left

local playScroll = Instance.new("ScrollingFrame", playbackContent)
playScroll.Size = UDim2.new(1, -20, 1, isMobile and -56 or -65)
playScroll.Position = UDim2.new(0, 10, 0, isMobile and 54 or 63)
playScroll.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
playScroll.BorderSizePixel = 0
playScroll.ScrollBarThickness = 0
Instance.new("UICorner", playScroll).CornerRadius = UDim.new(0, 8)

local playLayout = Instance.new("UIListLayout", playScroll)
playLayout.Padding = UDim.new(0, 5)

local playPadding = Instance.new("UIPadding", playScroll)
playPadding.PaddingTop = UDim.new(0, 6)
playPadding.PaddingBottom = UDim.new(0, 6)
playPadding.PaddingLeft = UDim.new(0, 6)
playPadding.PaddingRight = UDim.new(0, 6)

-- Rename Dialog
local renameDialog = Instance.new("Frame", screenGui)
renameDialog.Size = UDim2.new(0, isMobile and 260 or 300, 0, isMobile and 130 or 150)
renameDialog.Position = UDim2.new(0.5, 0, 0.5, 0)
renameDialog.AnchorPoint = Vector2.new(0.5, 0.5)
renameDialog.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
renameDialog.BorderSizePixel = 0
renameDialog.Visible = false
renameDialog.ZIndex = 100
Instance.new("UICorner", renameDialog).CornerRadius = UDim.new(0, 10)

local renameTitle = Instance.new("TextLabel", renameDialog)
renameTitle.Size = UDim2.new(1, 0, 0, isMobile and 35 or 40)
renameTitle.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
renameTitle.BorderSizePixel = 0
renameTitle.Text = "Rename Recording"
renameTitle.TextColor3 = Color3.new(1, 1, 1)
renameTitle.TextSize = isMobile and 13 or 16
renameTitle.Font = Enum.Font.GothamBold
renameTitle.ZIndex = 101
Instance.new("UICorner", renameTitle).CornerRadius = UDim.new(0, 10)

local renameInput = Instance.new("TextBox", renameDialog)
renameInput.Size = UDim2.new(1, -20, 0, isMobile and 30 or 35)
renameInput.Position = UDim2.new(0, 10, 0, isMobile and 42 or 50)
renameInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
renameInput.BorderSizePixel = 0
renameInput.Text = ""
renameInput.PlaceholderText = "Enter new name..."
renameInput.TextColor3 = Color3.new(1, 1, 1)
renameInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
renameInput.TextSize = isMobile and 11 or 14
renameInput.Font = Enum.Font.Gotham
renameInput.ClearTextOnFocus = false
renameInput.ZIndex = 101
Instance.new("UICorner", renameInput).CornerRadius = UDim.new(0, 6)

local renameInputPadding = Instance.new("UIPadding", renameInput)
renameInputPadding.PaddingLeft = UDim.new(0, 8)

local renameSaveBtn = Instance.new("TextButton", renameDialog)
renameSaveBtn.Size = UDim2.new(0.48, -5, 0, isMobile and 28 or 35)
renameSaveBtn.Position = UDim2.new(0, 10, 1, isMobile and -35 or -45)
renameSaveBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 220)
renameSaveBtn.BorderSizePixel = 0
renameSaveBtn.Text = "Save"
renameSaveBtn.TextColor3 = Color3.new(1, 1, 1)
renameSaveBtn.TextSize = isMobile and 11 or 14
renameSaveBtn.Font = Enum.Font.GothamBold
renameSaveBtn.ZIndex = 101
Instance.new("UICorner", renameSaveBtn).CornerRadius = UDim.new(0, 6)

local renameCancelBtn = Instance.new("TextButton", renameDialog)
renameCancelBtn.Size = UDim2.new(0.48, -5, 0, isMobile and 28 or 35)
renameCancelBtn.Position = UDim2.new(0.52, 0, 1, isMobile and -35 or -45)
renameCancelBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
renameCancelBtn.BorderSizePixel = 0
renameCancelBtn.Text = "Cancel"
renameCancelBtn.TextColor3 = Color3.new(1, 1, 1)
renameCancelBtn.TextSize = isMobile and 11 or 14
renameCancelBtn.Font = Enum.Font.GothamBold
renameCancelBtn.ZIndex = 101
Instance.new("UICorner", renameCancelBtn).CornerRadius = UDim.new(0, 6)

local currentRenameName = nil

renameCancelBtn.MouseButton1Click:Connect(function()
	renameDialog.Visible = false
	currentRenameName = nil
end)

renameSaveBtn.MouseButton1Click:Connect(function()
	local newName = renameInput.Text
	if newName and newName ~= "" and currentRenameName then
		if renameRecording(currentRenameName, newName) then
			renameDialog.Visible = false
			currentRenameName = nil
			refreshPlaybackList()
		else
			warn("‚ö†Ô∏è Failed to rename")
		end
	end
end)


-- ================= LOAD SCRIPT LIBRARY (MOUNT TAB) =================

loadScriptLibrary = function(autoMode)
    print("üìö Loading mount list..." .. (autoMode and " (auto)" or ""))
    
    mountScroll.Visible = true
    
    for _, child in pairs(mountScroll:GetChildren()) do
        if child:IsA("Frame") or child:IsA("TextLabel") then
            child:Destroy()
        end
    end
    
    local loadingLabel = Instance.new("TextLabel", mountScroll)
    loadingLabel.Size = UDim2.new(0.95, 0, 0, isMobile and 40 or 50)
    loadingLabel.BackgroundTransparency = 1
    loadingLabel.Text = autoMode and "Auto-loading mounts..." or "Loading..."
    loadingLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    loadingLabel.Font = Enum.Font.Gotham
    loadingLabel.TextSize = isMobile and 12 or 16
    
    task.spawn(function()
        local success, response = pcall(function()
            return game:HttpGet(BETATES_URL .. "/api/scripts", true)
        end)
        
        loadingLabel:Destroy()
        
        if not success then
            local errorLabel = Instance.new("TextLabel", mountScroll)
            errorLabel.Size = UDim2.new(0.95, 0, 0, isMobile and 50 or 60)
            errorLabel.BackgroundTransparency = 1
            errorLabel.Text = "‚ùå Failed to connect"
            errorLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            errorLabel.Font = Enum.Font.Gotham
            errorLabel.TextSize = isMobile and 12 or 15
            return
        end
        
        local jsonSuccess, scripts = pcall(HttpService.JSONDecode, HttpService, response)
        if not jsonSuccess then
            local errorLabel = Instance.new("TextLabel", mountScroll)
            errorLabel.Size = UDim2.new(0.95, 0, 0, isMobile and 50 or 60)
            errorLabel.BackgroundTransparency = 1
            errorLabel.Text = "‚ùå JSON Parse Error"
            errorLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            errorLabel.Font = Enum.Font.Gotham
            errorLabel.TextSize = isMobile and 12 or 15
            return
        end
        
        if type(scripts) ~= "table" then
            local errorLabel = Instance.new("TextLabel", mountScroll)
            errorLabel.Size = UDim2.new(0.95, 0, 0, isMobile and 50 or 60)
            errorLabel.BackgroundTransparency = 1
            errorLabel.Text = "‚ùå Invalid data type"
            errorLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            errorLabel.Font = Enum.Font.Gotham
            errorLabel.TextSize = isMobile and 12 or 15
            return
        end
        
        print("‚úÖ Loaded", #scripts, "mounts")
        
        if #scripts == 0 then
            local emptyLabel = Instance.new("TextLabel", mountScroll)
            emptyLabel.Size = UDim2.new(0.95, 0, 0, isMobile and 40 or 50)
            emptyLabel.BackgroundTransparency = 1
            emptyLabel.Text = "No mounts available"
            emptyLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
            emptyLabel.Font = Enum.Font.Gotham
            emptyLabel.TextSize = isMobile and 12 or 15
            return
        end
        
        for _, script in ipairs(scripts) do
            if not script or type(script) ~= "table" or not script.name then
                warn("‚ö†Ô∏è Invalid script entry:", script)
                continue
            end
            
            local isDownloaded = savedMounts[script.name] ~= nil
            
            local mountContainer = Instance.new("Frame", mountScroll)
            mountContainer.Size = UDim2.new(0.96, 0, 0, isMobile and 40 or 70)
            mountContainer.BackgroundColor3 = Color3.fromRGB(30, 34, 45)
            mountContainer.BackgroundTransparency = 0.3
            mountContainer.BorderSizePixel = 0
            Instance.new("UICorner", mountContainer).CornerRadius = UDim.new(0, 8)
            
            local containerStroke = Instance.new("UIStroke", mountContainer)
            containerStroke.Color = Color3.fromRGB(60, 65, 80)
            containerStroke.Thickness = 1
            
            local iconLabel = Instance.new("TextLabel", mountContainer)
            iconLabel.Size = UDim2.new(0, isMobile and 24 or 50, 0, isMobile and 24 or 50)
            iconLabel.Position = UDim2.new(0, isMobile and 6 or 12, 0.5, isMobile and -12 or -25)
            iconLabel.BackgroundTransparency = 1
            iconLabel.Text = isDownloaded and "‚úÖ" or "üèîÔ∏è"
            iconLabel.TextSize = isMobile and 14 or 30
            
            local nameLabel = Instance.new("TextLabel", mountContainer)
            nameLabel.Size = UDim2.new(1, isMobile and -180 or -290, 1, 0)
            nameLabel.Position = UDim2.new(0, isMobile and 34 or 70, 0, 0)
            nameLabel.BackgroundTransparency = 1
            nameLabel.Text = script.name
            nameLabel.TextColor3 = Color3.fromRGB(230, 235, 245)
            nameLabel.Font = Enum.Font.GothamMedium
            nameLabel.TextSize = isMobile and 10 or 15
            nameLabel.TextXAlignment = Enum.TextXAlignment.Left
            nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
            
            local downloadBtn = Instance.new("TextButton", mountContainer)
            downloadBtn.Size = UDim2.new(0, isMobile and 38 or 60, 0, isMobile and 26 or 45)
            downloadBtn.Position = UDim2.new(1, isMobile and -148 or -220, 0.5, isMobile and -13 or -22)
            downloadBtn.BackgroundColor3 = isDownloaded and Color3.fromRGB(100, 100, 100) or Color3.fromRGB(67, 181, 129)
            downloadBtn.BackgroundTransparency = 0.1
            downloadBtn.Text = isDownloaded and "‚úì" or "üì•"
            downloadBtn.TextColor3 = Color3.new(1, 1, 1)
            downloadBtn.Font = Enum.Font.GothamBold
            downloadBtn.TextSize = isMobile and 12 or 18
            Instance.new("UICorner", downloadBtn).CornerRadius = UDim.new(0, 6)
            
            local playBtn = Instance.new("TextButton", mountContainer)
            playBtn.Size = UDim2.new(0, isMobile and 38 or 60, 0, isMobile and 26 or 45)
            playBtn.Position = UDim2.new(1, isMobile and -104 or -155, 0.5, isMobile and -13 or -22)
            playBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
            playBtn.BackgroundTransparency = 0.1
            playBtn.Text = "‚ñ∂"
            playBtn.TextColor3 = Color3.new(1, 1, 1)
            playBtn.Font = Enum.Font.GothamBold
            playBtn.TextSize = isMobile and 14 or 20
            Instance.new("UICorner", playBtn).CornerRadius = UDim.new(0, 6)
            
            local stopBtn = Instance.new("TextButton", mountContainer)
            stopBtn.Size = UDim2.new(0, isMobile and 38 or 60, 0, isMobile and 26 or 45)
            stopBtn.Position = UDim2.new(1, isMobile and -60 or -90, 0.5, isMobile and -13 or -22)
            stopBtn.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
            stopBtn.BackgroundTransparency = 0.1
            stopBtn.Text = "STOP"
            stopBtn.TextColor3 = Color3.new(1, 1, 1)
            stopBtn.Font = Enum.Font.GothamBold
            stopBtn.TextSize = isMobile and 10 or 14
            Instance.new("UICorner", stopBtn).CornerRadius = UDim.new(0, 6)
            
            mountContainer.MouseEnter:Connect(function()
                containerStroke.Color = Color3.fromRGB(88, 101, 242)
                nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            end)
            
            mountContainer.MouseLeave:Connect(function()
                containerStroke.Color = Color3.fromRGB(60, 65, 80)
                nameLabel.TextColor3 = Color3.fromRGB(230, 235, 245)
            end)
            
            downloadBtn.MouseButton1Click:Connect(function()
                if savedMounts[script.name] then return end
                downloadBtn.Text = "..."
                downloadBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 110)
                local encodedName = urlEncode(script.name)
                print("üì• Downloading:", script.name)
                print("üîó URL:", BETATES_URL .. "/script/" .. encodedName .. "?admin=1")
                local scriptSuccess, scriptContent = pcall(function()
                    return game:HttpGet(BETATES_URL .. "/script/" .. encodedName .. "?admin=1", true)
                end)
                if scriptSuccess and scriptContent and #scriptContent > 0 and not scriptContent:match("Script not found") then
                    print("‚úÖ Downloaded " .. #scriptContent .. " bytes")
                    print("üìù First 100 chars:", scriptContent:sub(1, 100))
                    saveMountToStorage(script.name, scriptContent)
                    downloadBtn.Text = "‚úì"
                    downloadBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                    iconLabel.Text = "‚úÖ"
                else
                    downloadBtn.Text = "‚úó"
                    downloadBtn.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
                    warn("‚ùå Download failed:", script.name)
                    if scriptContent then
                        warn("Response:", scriptContent:sub(1, 200))
                    end
                    task.wait(1.5)
                    downloadBtn.Text = "üì•"
                    downloadBtn.BackgroundColor3 = Color3.fromRGB(67, 181, 129)
                end
            end)
            
            playBtn.MouseButton1Click:Connect(function()
                playBtn.Text = "..."
                playBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 110)
                
                local scriptContent = savedMounts[script.name]
                if not scriptContent then
                    local encodedName = urlEncode(script.name)
                    local scriptSuccess, content = pcall(function()
                        return game:HttpGet(BETATES_URL .. "/script/" .. encodedName .. "?admin=1", true)
                    end)
                    if scriptSuccess and content and #content > 0 and not content:match("Script not found") then
                        saveMountToStorage(script.name, content)
                        scriptContent = content
                        downloadBtn.Text = "‚úì"
                        downloadBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                        iconLabel.Text = "‚úÖ"
                    else
                        playBtn.Text = "‚úó"
                        playBtn.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
                        warn("‚ùå Failed to load:", script.name)
                        task.wait(1)
                        playBtn.Text = "‚ñ∂"
                        playBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
                        return
                    end
                end
                
                if not scriptContent or #scriptContent == 0 then
                    playBtn.Text = "‚úó"
                    playBtn.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
                    warn("‚ùå Empty content")
                    task.wait(1)
                    playBtn.Text = "‚ñ∂"
                    playBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
                    return
                end
                
                -- Mount is recording data, not script - deserialize and play
                local success, rec = pcall(function()
                    return deserialize(scriptContent)
                end)
                
                if not success or not rec or not rec.frames or #rec.frames == 0 then
                    playBtn.Text = "‚úó"
                    playBtn.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
                    warn("‚ùå Invalid mount data:", tostring(rec))
                    task.wait(1)
                    playBtn.Text = "‚ñ∂"
                    playBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
                    return
                end
                
                if not Player.Character then
                    playBtn.Text = "‚úó"
                    playBtn.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
                    warn("‚ùå No character")
                    task.wait(1)
                    playBtn.Text = "‚ñ∂"
                    playBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
                    return
                end
                
                system:startPlayback(Player.Character, rec)
                playBtn.Text = "‚úì"
                playBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 100)
                print("‚úÖ Playing mount:", script.name, "-", #rec.frames, "frames")
                
                task.wait(1.5)
                playBtn.Text = "‚ñ∂"
                playBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
            end)
            
            stopBtn.MouseButton1Click:Connect(function()
                system:forceStop()
                stopBtn.Text = "OK"
                stopBtn.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
                task.wait(0.5)
                stopBtn.Text = "STOP"
                stopBtn.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
            end)
        end
        
        mountScroll.CanvasSize = UDim2.new(0, 0, 0, mountLayout.AbsoluteContentSize.Y + (isMobile and 16 or 24))
        
        -- Auto-download all mounts with delay (only in auto mode)
        if autoMode then
            task.spawn(function()
                task.wait(2)
                print("üîÑ Auto-downloading mounts...")
                local downloaded = 0
                for _, script in ipairs(scripts) do
                    if not savedMounts[script.name] then
                        local encodedName = urlEncode(script.name)
                        local scriptSuccess, scriptContent = pcall(function()
                            return game:HttpGet(BETATES_URL .. "/script/" .. encodedName .. "?admin=1", true)
                        end)
                        if scriptSuccess and scriptContent and not scriptContent:match("Script not found") then
                            saveMountToStorage(script.name, scriptContent)
                            downloaded = downloaded + 1
                            print("‚úÖ Downloaded:", script.name)
                        end
                        task.wait(0.5) -- Delay 0.5s per download
                    end
                end
                print("‚úÖ Auto-download complete:", downloaded, "new mounts")
                -- Refresh UI to show checkmarks
                if downloaded > 0 then
                    loadScriptLibrary(false)
                end
            end)
        end
    end)
end

-- ================= REFRESH PLAYBACK LIST =================
function refreshPlaybackList()
	print("üîÑ Refreshing playback list...")
	
	for _, child in ipairs(playScroll:GetChildren()) do
		if child:IsA("Frame") or child:IsA("TextLabel") then
			child:Destroy()
		end
	end
	
	local list = listRecordings()
	local count = #list
	
	playLabel.Text = "Saved Recordings: (" .. count .. ")"
	print("üìã Found " .. count .. " recordings")
	
	if count == 0 then
		local empty = Instance.new("TextLabel", playScroll)
		empty.Size = UDim2.new(1, -10, 0, isMobile and 35 or 40)
		empty.BackgroundTransparency = 1
		empty.Text = "No recordings yet"
		empty.TextColor3 = Color3.fromRGB(120, 120, 120)
		empty.TextSize = isMobile and 11 or 13
		empty.Font = Enum.Font.Gotham
		return
	end
	
	for _, name in ipairs(list) do
		print("‚ûï Adding: " .. name)
		
		local item = Instance.new("Frame", playScroll)
		item.Size = UDim2.new(1, 0, 0, isMobile and 36 or 40)
		item.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
		item.BorderSizePixel = 0
		Instance.new("UICorner", item).CornerRadius = UDim.new(0, 8)
		
		local label = Instance.new("TextLabel", item)
		label.Size = UDim2.new(1, isMobile and -160 or -180, 1, 0)
		label.Position = UDim2.new(0, 10, 0, 0)
		label.BackgroundTransparency = 1
		label.Text = name
		label.TextColor3 = Color3.new(1, 1, 1)
		label.TextSize = isMobile and 11 or 13
		label.Font = Enum.Font.GothamBold
		label.TextXAlignment = Enum.TextXAlignment.Left
		label.TextTruncate = Enum.TextTruncate.AtEnd
		
		local btnSize = isMobile and 28 or 32
		local btnSpacing = isMobile and 4 or 6
		
		local play = Instance.new("TextButton", item)
		play.Size = UDim2.new(0, btnSize, 0, btnSize)
		play.Position = UDim2.new(1, -(btnSize * 4 + btnSpacing * 3 + 10), 0.5, -btnSize/2)
		play.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
		play.BorderSizePixel = 0
		play.Text = "‚ñ∂"
		play.TextColor3 = Color3.new(1, 1, 1)
		play.TextSize = isMobile and 14 or 16
		play.Font = Enum.Font.GothamBold
		Instance.new("UICorner", play).CornerRadius = UDim.new(0, 6)
		
		local stop = Instance.new("TextButton", item)
		stop.Size = UDim2.new(0, btnSize, 0, btnSize)
		stop.Position = UDim2.new(1, -(btnSize * 3 + btnSpacing * 2 + 10), 0.5, -btnSize/2)
		stop.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
		stop.BorderSizePixel = 0
		stop.Text = "STOP"
		stop.TextColor3 = Color3.new(1, 1, 1)
		stop.TextSize = isMobile and 9 or 11
		stop.Font = Enum.Font.GothamBold
		Instance.new("UICorner", stop).CornerRadius = UDim.new(0, 6)
		
		local edit = Instance.new("TextButton", item)
		edit.Size = UDim2.new(0, btnSize, 0, btnSize)
		edit.Position = UDim2.new(1, -(btnSize * 2 + btnSpacing + 10), 0.5, -btnSize/2)
		edit.BackgroundColor3 = Color3.fromRGB(59, 130, 246)
		edit.BorderSizePixel = 0
		edit.Text = "‚úè"
		edit.TextColor3 = Color3.new(1, 1, 1)
		edit.TextSize = isMobile and 14 or 16
		edit.Font = Enum.Font.GothamBold
		Instance.new("UICorner", edit).CornerRadius = UDim.new(0, 6)
		
		local del = Instance.new("TextButton", item)
		del.Size = UDim2.new(0, btnSize, 0, btnSize)
		del.Position = UDim2.new(1, -(btnSize + 10), 0.5, -btnSize/2)
		del.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
		del.BorderSizePixel = 0
		del.Text = "üóë"
		del.TextColor3 = Color3.new(1, 1, 1)
		del.TextSize = isMobile and 14 or 16
		del.Font = Enum.Font.GothamBold
		Instance.new("UICorner", del).CornerRadius = UDim.new(0, 6)
		
		play.MouseButton1Click:Connect(function()
			print("========================================")
			print("‚ñ∂Ô∏è PLAY BUTTON CLICKED: " .. name)
			print("========================================")
			
			-- Check if system exists
			if not system then
				warn("‚ùå ERROR: System is nil!")
				return
			end
			print("‚úÖ System exists")
			
			-- Load recording data
			print("üìÇ Loading recording data...")
			local data = loadRecording(name)
			
			if not data then
				warn("‚ùå ERROR: Failed to load recording data for: " .. name)
				warn("‚ùå Recording might not exist in storage")
				return
			end
			print("‚úÖ Recording data loaded, length: " .. #data)
			
			-- Deserialize
			print("üîÑ Deserializing recording...")
			local success, rec = pcall(function()
				return deserialize(data)
			end)
			
			if not success then
				warn("‚ùå ERROR: Failed to deserialize recording!")
				warn("‚ùå Error: " .. tostring(rec))
				return
			end
			
			if not rec then
				warn("‚ùå ERROR: Deserialized recording is nil!")
				return
			end
			print("‚úÖ Deserialized successfully")
			print("üìä Recording info:")
			print("   - Name: " .. (rec.name or "unknown"))
			print("   - Frames: " .. (rec.frameCount or 0))
			print("   - Hip Height: " .. (rec.hipHeight or 0))
			
			-- Check character
			if not Player.Character then
				warn("‚ùå ERROR: Player.Character is nil!")
				return
			end
			print("‚úÖ Player.Character exists")
			
			-- Check HumanoidRootPart
			local hrp = Player.Character:FindFirstChild("HumanoidRootPart")
			if not hrp then
				warn("‚ùå ERROR: HumanoidRootPart not found!")
				return
			end
			print("‚úÖ HumanoidRootPart found")
			
			-- Start playback
			print("üé¨ Starting playback...")
			local playSuccess, playError = pcall(function()
				system:startPlayback(Player.Character, rec)
			end)
			
			if not playSuccess then
				warn("‚ùå ERROR: Failed to start playback!")
				warn("‚ùå Error: " .. tostring(playError))
				return
			end
			
			print("‚úÖ Playback started successfully!")
			recFrames.Text = "Playing: " .. rec.frameCount .. " frames"
			updateRecorderUI()
			print("========================================")
		end)
		
		stop.MouseButton1Click:Connect(function()
			system:forceStop()
			recFrames.Text = "Stopped"
			updateRecorderUI()
			stop.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
			task.wait(0.5)
			stop.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
		end)
		
		edit.MouseButton1Click:Connect(function()
			print("‚úèÔ∏è Editing: " .. name)
			currentRenameName = name
			renameInput.Text = name
			renameDialog.Visible = true
		end)
		
		del.MouseButton1Click:Connect(function()
			print("üóëÔ∏è Deleting: " .. name)
			deleteRecording(name)
			refreshPlaybackList()
		end)
	end
	
	playScroll.CanvasSize = UDim2.new(0, 0, 0, playLayout.AbsoluteContentSize.Y + 10)
	print("‚úÖ List refreshed")
end

-- ================= RECORDER FUNCTIONS =================
-- system sudah diinisialisasi di atas (setelah System class)

function updateRecorderUI()
	local s = system.state
	recStatus.Text = "Status: " .. (s == "idle" and "Idle" or s == "recording" and "Recording" or "Playing")
	recStatus.TextColor3 = s == "idle" and Color3.fromRGB(200, 200, 200) or 
	                     s == "recording" and Color3.fromRGB(220, 50, 50) or 
	                     Color3.fromRGB(50, 200, 100)
end

recordBtn.MouseButton1Click:Connect(function()
	print("üî¥ Recording started")
	system:startRecording(Player.Character)
	recordedFrames = nil
	recFrames.Text = "Recording..."
	updateRecorderUI()
end)

stopBtn.MouseButton1Click:Connect(function()
	print("‚èπÔ∏è Stop clicked")
	if system.state == "recording" then
		local frames, hipHeight, animationIds = system:stopRecording()
		recordedFrames = {frames = frames, hipHeight = hipHeight, animationIds = animationIds}
		if frames then
			recFrames.Text = "Frames: " .. #frames
			print("‚úì Recorded " .. #frames .. " frames (HipHeight: " .. hipHeight .. ")")
			if animationIds and #animationIds > 0 then
				print("‚úì Recorded " .. #animationIds .. " animation(s)")
			end
		end
	else
		system:forceStop()
		recFrames.Text = "Stopped"
	end
	updateRecorderUI()
end)

saveBtn.MouseButton1Click:Connect(function()
	print("üíæ Save clicked")
	
	if system.state == "recording" then
		print("‚èπÔ∏è Auto-stopping recording before save...")
		local frames, hipHeight, animationIds = system:stopRecording()
		recordedFrames = {frames = frames, hipHeight = hipHeight, animationIds = animationIds}
		if frames then
			recFrames.Text = "Frames: " .. #frames
			print("‚úì Recorded " .. #frames .. " frames (HipHeight: " .. hipHeight .. ")")
			if animationIds and #animationIds > 0 then
				print("‚úì Recorded " .. #animationIds .. " animation(s)")
			end
		end
		updateRecorderUI()
		task.wait(0.1)
	end
	
	if not recordedFrames or not recordedFrames.frames or #recordedFrames.frames == 0 then
		warn("‚ö†Ô∏è No recording to save")
		return
	end
	
	local name = "rec_" .. os.date("%H%M%S")
	print("üìù Saving: " .. name .. " (" .. #recordedFrames.frames .. " frames)")
	
	local data = serialize(name, recordedFrames.frames, recordedFrames.hipHeight, recordedFrames.animationIds)
	saveRecording(name, data)
	
	print("‚úÖ Saved! Total: " .. getRecordingCount())
	print("üîÑ Refreshing list...")
	
	refreshPlaybackList()
end)

task.spawn(function()
	while true do
		task.wait(0.3)
		updateRecorderUI()
		if system.state == "recording" and system.recorder then
			recFrames.Text = "Recording: " .. #system.recorder.frames .. " frames"
		end
	end
end)

-- ================= EVENTS =================
floatBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
end)

-- ================= STARTUP =================
print("=== FEDLY AUTO WALK SYSTEM (NO KEY) ===")
print("‚úÖ Direct access - no login required")
print("üì± Mobile optimized: " .. tostring(isMobile))
print("üé¨ Auto Walk Recorder & Playback")
print("üé≠ Animations recorded automatically")
print("=====================================")

-- Load saved recordings on startup
loadAllRecordingsFromFile()
refreshPlaybackList()

updateRecorderUI()
